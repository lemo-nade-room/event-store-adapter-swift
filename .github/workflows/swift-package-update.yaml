name: Weekly Swift Package Update

on:
  schedule:
    - cron: '0 21 * * 6'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  actions: write

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_PUSH }}

      - run: swift package update

      - name: Detect changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain Package.resolved) ]]; then
            echo "modified=true" >> "$GITHUB_OUTPUT"
          else
            echo "modified=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit & push, then create / update PR
        if: steps.changes.outputs.modified == 'true'
        env:
          BRANCH_NAME: chore/swift-package-update
          GH_TOKEN: ${{ secrets.PAT_PUSH }}
        run: |
          set -euo pipefail

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 1ï¸âƒ£ å¤ã„ãƒªãƒ¢ãƒ¼ãƒˆãƒ–ãƒ©ãƒ³ãƒã‚’å‰Šé™¤ï¼ˆå­˜åœ¨ã—ãªãã¦ã‚‚ OKï¼‰
          git push origin --delete "$BRANCH_NAME" || true

          # 2ï¸âƒ£ æ¯å›ã‚¯ãƒªãƒ¼ãƒ³ãªä½œæ¥­ãƒ–ãƒ©ãƒ³ãƒã‚’å†ç”Ÿæˆ
          git switch --create "$BRANCH_NAME"

          # 3ï¸âƒ£ å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆï¼ˆå·®åˆ†ãŒç©ºãªã‚‰ã‚¹ã‚­ãƒƒãƒ—ï¼‰
          git add Package.resolved
          git diff --cached --quiet && exit 0
          git commit -m "chore: â¬†ï¸ Update Swift packages"

          # 4ï¸âƒ£ å¼·åˆ¶ã§ã‚‚å®‰å…¨ã« pushï¼ˆè‡ªå‹•ç”Ÿæˆãƒ–ãƒ©ãƒ³ãƒå°‚ç”¨ãªã®ã§ä¸Šæ›¸ãå¯ï¼‰
          git push --force --set-upstream origin "$BRANCH_NAME"

          # 5ï¸âƒ£ PR ä½œæˆã¾ãŸã¯æ›´æ–°ï¼‹ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ä»˜ä¸
          if gh pr view "$BRANCH_NAME" --json number >/dev/null 2>&1; then
            gh pr edit "$BRANCH_NAME" \
              --title "ğŸ“¦ Update Swift packages" \
              --body  "Swift ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æœ€æ–°åŒ–ã—ã¾ã—ãŸã€‚Package.resolved ã®å·®åˆ†ã‚’ã”ç¢ºèªãã ã•ã„ã€‚" \
              --add-reviewer lemo-nade-room
          else
            gh pr create \
              --base main \
              --head "$BRANCH_NAME" \
              --title "ğŸ“¦ Update Swift packages" \
              --body "Swift ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æœ€æ–°åŒ–ã—ã¾ã—ãŸã€‚Package.resolved ã®å·®åˆ†ã‚’ã”ç¢ºèªãã ã•ã„ã€‚" \
              --reviewer lemo-nade-room
          fi
